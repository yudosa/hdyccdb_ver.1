<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 취소 - 흥덕청소년 문화의집</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="firebase-config.js"></script>
    <style>
        .cancel-form-block {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
            padding: 48px 32px 32px 32px;
            margin: 0 auto;
            max-width: 700px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .cancel-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: #e74c3c;
            margin-bottom: 18px;
            text-align: center;
        }
        .cancel-desc {
            font-size: 1.12rem;
            color: #555;
            margin-bottom: 32px;
            text-align: center;
        }
        .search-form {
            width: 100%;
            margin-bottom: 32px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .form-group input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 16px;
            font-size: 1.12rem;
            font-weight: 600;
            color: #3498db;
            background: #fff;
            transition: border-color 0.18s, box-shadow 0.18s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .search-btn {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 16px;
            font-size: 1.12rem;
            font-weight: 700;
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
            color: #222;
            cursor: pointer;
            transition: transform 0.18s;
        }
        .search-btn:hover {
            transform: translateY(-2px);
        }
        .reservation-list {
            width: 100%;
            margin-top: 24px;
        }
        .reservation-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(52, 152, 219, 0.08);
        }
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .reservation-name {
            font-weight: 800;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        .reservation-date {
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .reservation-details {
            margin-bottom: 16px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .detail-label {
            font-weight: 700;
            color: #3498db;
            font-size: 1.15rem;
        }
        .detail-value {
            color: #2c3e50;
            font-size: 1.15rem;
            font-weight: 700;
        }
        .cancel-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            cursor: pointer;
            transition: transform 0.18s;
        }
        .cancel-btn:hover {
            transform: translateY(-1px);
        }
        .no-reservation {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
            padding: 40px 20px;
        }
        .loading {
            text-align: center;
            color: #3498db;
            font-size: 1.1rem;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="rental-wrapper">
        <div class="rental-container">
            <img src="hd.JPG" alt="흥덕청소년 문화의집 건물" class="main-building-img">
            <header class="rental-header" style="padding: 21px 0 0 0;">
                <h1 style="font-size:1.47rem; font-weight:800; color:#222; margin-bottom:8px;">예약 취소</h1>
                <p class="rental-subtitle" style="font-size:1.12rem; color:#555; text-align:center; margin-bottom:21px;">본인의 예약 내역을 확인하고 취소하세요</p>
            </header>
            <main class="rental-main">
                <div class="cancel-form-block">
                    <div class="cancel-title" style="font-size:1.47rem; font-weight:800; color:#e74c3c; margin-bottom:8px;">예약 조회</div>
                    <div class="cancel-desc" style="font-size:1.12rem; color:#555; text-align:center; margin-bottom:21px;">이름과 전화번호를 입력하여 본인의 예약 내역을 확인하세요.</div>
                    
                    <form class="search-form" id="searchForm">
                        <div class="form-group">
                            <label for="searchName">이름</label>
                            <input type="text" id="searchName" name="searchName" placeholder="이름을 입력하세요" required>
                        </div>
                        <div class="form-group">
                            <label for="searchPhone">전화번호</label>
                            <input type="tel" id="searchPhone" name="searchPhone" placeholder="예: 010-1234-5678" required>
                        </div>
                        <button type="submit" class="search-btn">예약 내역 조회</button>
                    </form>
                    
                    <div class="reservation-list" id="reservationList" style="display: none;">
                        <!-- 예약 내역이 여기에 표시됩니다 -->
                    </div>
                    
                    <div class="form-actions-centered">
                        <button class="btn-secondary-centered" onclick="window.location.href='index.html'" style="color:#222;">↻ 처음으로</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 전화번호 자동 포맷팅
        document.getElementById('searchPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (value.length >= 3 && value.length <= 6) {
                value = value.replace(/(\d{3})(\d{0,3})/, '$1-$2');
            } else if (value.length >= 7) {
                value = value.replace(/(\d{3})(\d{3,4})(\d{0,4})/, '$1-$2-$3');
            }
            
            e.target.value = value;
        });

        // 예약 조회 폼 제출
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('searchName').value.trim();
            const phone = document.getElementById('searchPhone').value.trim();
            
            if (!name || !phone) {
                showModal('이름과 전화번호를 모두 입력해주세요.');
                return;
            }
            
            // 전화번호 유효성 검사
            const phoneDigits = phone.replace(/[^0-9]/g, '');
            
            if (phoneDigits.length !== 11) {
                showModal('전화번호 형식이 잘못되었습니다.\n11자리 전화번호를 모두 입력해주세요.');
                document.getElementById('searchPhone').focus();
                return;
            }
            
            searchReservations(name, phone);
        });

        // 예약 조회 API 호출
        async function searchReservations(name, phone) {
            const reservationList = document.getElementById('reservationList');
            reservationList.style.display = 'block';
            reservationList.innerHTML = '<div class="loading">예약 내역을 조회하는 중...</div>';
            
            try {
                const response = await fetch('/api/reservations');
                if (!response.ok) {
                    throw new Error('예약 내역을 불러올 수 없습니다.');
                }
                
                const reservations = await response.json();
                
                // 이름과 전화번호로 필터링
                const userReservations = reservations.filter(reservation => 
                    reservation.name === name && reservation.phone === phone
                );
                
                displayReservations(userReservations);
                
            } catch (error) {
                console.error('예약 조회 오류:', error);
                reservationList.innerHTML = '<div class="no-reservation">예약 내역을 불러올 수 없습니다.</div>';
            }
        }

        // 예약 내역 표시
        function displayReservations(reservations) {
            window.lastReservations = reservations;
            console.log('예약 데이터:', reservations);
            const reservationList = document.getElementById('reservationList');
            if (reservations.length === 0) {
                reservationList.innerHTML = '<div class="no-reservation">해당 정보로 등록된 예약이 없습니다.</div>';
                return;
            }
            reservations.sort((a, b) => new Date(b.date) - new Date(a.date));
            let html = '';
            reservations.forEach((reservation, idx) => {
                const displayNumber = idx + 1;
                const idStr = reservation.id ? `#${reservation.id}` : '-';
                html += `
                    <div class="reservation-item">
                        <div class="reservation-header">
                            <div class="reservation-name">${reservation.name}님의 예약</div>
                            <div class="reservation-date">${formatDate(reservation.date)}</div>
                        </div>
                        <div class="reservation-details">
                            <div class="detail-row">
                                <span class="detail-label">시설명:</span>
                                <span class="detail-value">${reservation.facility}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">세부선택:</span>
                                <span class="detail-value">${reservation.detail !== '-' ? reservation.detail : '-'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">예약시간:</span>
                                <span class="detail-value">${reservation.start_time} ~ ${reservation.end_time}</span>
                            </div>
                            ${reservation.purpose ? `
                            <div class="detail-row">
                                <span class="detail-label">이용목적:</span>
                                <span class="detail-value">${reservation.purpose}</span>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <span class="detail-label">예약번호:</span>
                                <span class="detail-value">#${displayNumber} (${idStr})</span>
                            </div>
                        </div>
                        ${reservation.status === 'cancelled' ? `<div style="color:#e74c3c;font-weight:700;">[취소된 예약]</div>` : `<button class="cancel-btn" data-id="${reservation.id}" onclick="cancelReservation(this)">예약 취소</button>`}
                    </div>
                `;
            });
            reservationList.innerHTML = html;
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
            
            return `${year}년 ${month}월 ${day}일 (${dayOfWeek})`;
        }

        // 예약 취소
        async function cancelReservation(btn) {
            const reservationId = btn.getAttribute('data-id');
            if (!reservationId) {
                alert('예약 ID를 찾을 수 없습니다.');
                return;
            }
            // 예약 정보 찾기
            const reservation = window.lastReservations?.find(r => r.id === reservationId);
            if (!reservation) {
                alert('예약 정보를 찾을 수 없습니다.');
                return;
            }
            showCancelModal(reservation, async () => {
                try {
                    const response = await fetch(`/api/reservations/${reservationId}/cancel`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('예약이 취소되었습니다.');
                        loadMyReservations();
                    } else {
                        if (result.error && result.error.includes('이미 취소된 예약')) {
                            loadMyReservations();
                            return;
                        }
                        alert(result.error || '예약 취소에 실패했습니다.');
                    }
                } catch (e) {
                    alert('예약 취소 중 오류가 발생했습니다.');
                }
            });
        }
        
        // 모던 커스텀 모달 함수 추가
        function showCancelModal(reservation, onConfirm) {
            // 기존 모달 제거
            document.querySelectorAll('.custom-modal-backdrop').forEach(e => e.remove());
            const backdrop = document.createElement('div');
            backdrop.className = 'custom-modal-backdrop';
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            // X 닫기 버튼
            const closeBtn = document.createElement('button');
            closeBtn.className = 'custom-modal-close';
            closeBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#878481"/>
                    <path d="M0 0h24v24H0z" fill="none"/>
                </svg>
            `;
            closeBtn.onclick = () => backdrop.remove();
            modal.appendChild(closeBtn);
            // 예약 내역
            const msgDiv = document.createElement('div');
            msgDiv.style.margin = '24px 0 12px 0';
            msgDiv.style.fontSize = '1.15rem';
            msgDiv.style.fontWeight = '600';
            msgDiv.innerHTML = `
                <div style="margin-bottom:12px;font-weight:800;font-size:1.1rem;">${reservation.name}님의 예약</div>
                <div style="color:#555;margin-bottom:8px;">시설명: <b>${reservation.facility}</b> &nbsp; 세부선택: <b>${reservation.detail || '-'}</b></div>
                <div style="color:#555;margin-bottom:8px;">예약일: <b>${reservation.date}</b> &nbsp; 예약시간: <b>${reservation.start_time} ~ ${reservation.end_time}</b></div>
                <div style="color:#555;margin-bottom:8px;">예약번호: <b>#${reservation.id}</b></div>
                <div style="margin:18px 0 0 0;color:#e74c3c;font-weight:700;">예약을 취소하시겠습니까?</div>
            `;
            modal.appendChild(msgDiv);
            // 버튼
            const btns = document.createElement('div');
            btns.className = 'custom-modal-btns';
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'custom-modal-btn';
            cancelBtn.textContent = '취소';
            cancelBtn.onclick = () => backdrop.remove();
            btns.appendChild(cancelBtn);
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'custom-modal-btn danger';
            confirmBtn.textContent = '확인';
            confirmBtn.onclick = () => { backdrop.remove(); onConfirm(); };
            btns.appendChild(confirmBtn);
            modal.appendChild(btns);
            backdrop.appendChild(modal);
            document.body.appendChild(backdrop);
        }

        window.cancelReservation = cancelReservation;
    </script>
</body>
</html>