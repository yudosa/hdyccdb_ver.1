<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ ë‚ ì§œì™€ ì‹œê°„ ì„ íƒ - í¥ë•ì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="firebase-config.js"></script>
    <style>
        .time-select-block { margin-top: 28px; }
        .ampm-tabs { display: flex; gap: 12px; margin-bottom: 18px; }
        .ampm-tab { flex: 1; padding: 10px 0; border-radius: 16px; border: none; font-weight: 700; font-size: 1.08rem; background: #f5f5f5; color: #3498db; cursor: pointer; transition: background 0.18s, color 0.18s; }
        .ampm-tab.active { background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%); color: #222; }
        .time-btn-group { display: flex; flex-wrap: wrap; gap: 12px; }
        .time-btn { 
            min-width: 90px; 
            padding: 12px 0; 
            border-radius: 16px; 
            border: none; 
            font-size: 1.08rem; 
            font-weight: 600; 
            background: #e0e7ef; 
            color: #3498db; 
            cursor: pointer; 
            transition: background 0.18s, color 0.18s; 
        }
        .time-btn.selected { 
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%); 
            color: #222; 
        }
        .time-btn.disabled {
            background: #cccccc !important;
            color: #888888 !important;
            cursor: not-allowed !important;
            text-decoration: line-through !important;
            opacity: 0.5 !important;
            pointer-events: none !important;
            border: 2px solid #999999 !important;
        }
        .reservation-calendar-block {
            background: #fafbfc;
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(52, 152, 219, 0.08);
            padding: 32px 24px 24px 24px;
            margin: 32px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            margin-bottom: 18px;
        }
        .calendar-title {
            font-size: 1.45rem;
            font-weight: 700;
            color: #222;
            letter-spacing: 1px;
        }
        .calendar-nav-btn {
            background: linear-gradient(90deg, #ffd6e3 0%, #a8edea 100%);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
            color: #ff6f61;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.10);
            cursor: pointer;
            transition: background 0.18s, color 0.18s, transform 0.18s;
        }
        .calendar-nav-btn:hover {
            background: linear-gradient(90deg, #a8edea 0%, #ffd6e3 100%);
            color: #d84315;
            transform: scale(1.08);
        }
        .reservation-calendar {
            width: 100%;
            max-width: 420px;
            border-collapse: separate;
            border-spacing: 0 12px;
        }
        .reservation-calendar th {
            font-size: 1.12rem;
            color: #3498db;
            font-weight: 700;
            padding-bottom: 8px;
        }
        .reservation-calendar td {
            text-align: center;
            padding: 0;
        }
        .calendar-day {
            width: 48px;
            height: 48px;
            line-height: 48px;
            font-size: 1.18rem;
            font-weight: 600;
            border-radius: 50%;
            background: #fff;
            color: #222;
            margin: 0 auto;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            box-shadow: 0 1px 4px rgba(52, 152, 219, 0.06);
            border: 2px solid transparent;
        }
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        .calendar-day.saturday {
            color: #3498db !important;
        }
        .calendar-day.selected {
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
            color: #fff !important;
            border: 2px solid #3498db;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.13);
        }
        .calendar-day.disabled {
            background: #f0f0f0;
            color: #bbb !important;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .calendar-day:not(.selected):hover:not(.disabled) {
            background: #e0f7fa;
            color: #3498db;
            border: 2px solid #a8edea;
        }
        .reservation-detail-select {
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .detail-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
            padding: 32px 24px 24px 24px;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 540px;
            width: 100%;
        }
        .detail-label {
            font-size: 1.18rem;
            font-weight: 800;
            color: #3498db;
            margin-bottom: 18px;
            letter-spacing: 1px;
        }
        .detail-select {
            width: 100%;
            max-width: 420px;
            padding: 16px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 16px;
            font-size: 1.12rem;
            font-weight: 600;
            color: #3498db;
            background: #fff;
            cursor: pointer;
            transition: border-color 0.18s, box-shadow 0.18s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233498db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
            padding-right: 48px;
        }
        .detail-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
    </style>
</head>
<body>
    <div class="rental-wrapper">
        <div class="rental-container">
            <img src="hd.JPG" alt="í¥ë•ì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
            <header class="rental-header">
                <h1 id="facilityTitle">ì‹œì„¤ ì´ìš© ì‹ ì²­</h1>
                <p class="rental-subtitle">ì˜ˆì•½ ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </header>
            <main class="rental-main">
                <div class="rental-form-centered reservation-date-form">
                    <div class="detail-card">
                        <div class="detail-label">ì„¸ë¶€ì„ íƒ</div>
                        <select class="detail-select" id="detailSelect">
                            <option value="ë‹Œí…ë„1">ğŸ® ë‹Œí…ë„1</option>
                            <option value="ë‹Œí…ë„2">ğŸ® ë‹Œí…ë„2</option>
                            <option value="ë‹Œí…ë„3">ğŸ® ë‹Œí…ë„3</option>
                            <option value="ë‹Œí…ë„4">ğŸ® ë‹Œí…ë„4</option>
                            <option value="ë‹Œí…ë„5">ğŸ® ë‹Œí…ë„5</option>
                            <option value="ë‹Œí…ë„6">ğŸ® ë‹Œí…ë„6</option>
                            <option value="ë‹Œí…ë„7">ğŸ® ë‹Œí…ë„7</option>
                            <option value="ë‹Œí…ë„8">ğŸ® ë‹Œí…ë„8</option>
                            <option value="ë‹Œí…ë„9">ğŸ® ë‹Œí…ë„9</option>
                        </select>
                    </div>
                    <div class="reservation-calendar-block">
                        <div class="calendar-header">
                            <button class="calendar-nav-btn" id="prevMonth">â—€</button>
                            <span class="calendar-title" id="calendarTitle"></span>
                            <button class="calendar-nav-btn" id="nextMonth">â–¶</button>
                        </div>
                        <table class="reservation-calendar">
                            <thead>
                                <tr>
                                    <th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="time-select-block" id="timeSelectBlock" style="display:none;"></div>
                    <div class="form-actions-centered">
                        <button class="btn-secondary-centered" style="color:#222;">â—€ ì´ì „</button>
                        <button class="btn-secondary-centered" style="color:#222;">ë‹¤ìŒ â–¶</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        const timeSlots = [
        '09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'
    ];
    const amSlots = timeSlots.slice(0, 4); // 09~12
    const pmSlots = timeSlots.slice(4);   // 13~19

    let selectedFacility = 'ë‹Œí…ë„1';
    let selectedDate = null;
    let selectedTime = null;
    
    // ì˜ˆì•½ ë°ì´í„° (APIì—ì„œ ê°€ì ¸ì˜´)
    let reservationData = {};

    // ì˜ˆì•½ ë°ì´í„°ë¥¼ ì •í™•íˆ ë§¤ì¹­í•˜ëŠ” í•¨ìˆ˜
    function getReservedTimes(facility, detail, date) {
        console.log('=== getReservedTimes í•¨ìˆ˜ í˜¸ì¶œ ===');
        // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
        const detailKey = (facility === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤' || facility === 'ë‹¤ëª©ì ì‹¤') ? '-' : detail;
        const key = facility + '||' + (detailKey || '-');
        console.log('ì…ë ¥ ë§¤ê°œë³€ìˆ˜:', { facility, detail, date });
        console.log('ì‹¤ì œ ê²€ìƒ‰ í‚¤:', key);
        if (!reservationData || Object.keys(reservationData).length === 0) {
            console.log('ì˜ˆì•½ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');
            return [];
        }
        if (reservationData[key] && reservationData[key][date]) {
            return reservationData[key][date];
        }
        console.log('ì˜ˆì•½ëœ ì‹œê°„ ì—†ìŒ');
        return [];
    }

    // ì‹œì„¤ëª…ì— ë”°ë¼ ì„¸ë¶€ì„ íƒ ì˜µì…˜ ë™ì  ìƒì„±
    const facilityName = localStorage.getItem('reservationFacility') || '';
    const detailCard = document.querySelector('.detail-card');
    const detailLabel = document.querySelector('.detail-label');
    const detailSelect = document.getElementById('detailSelect');

    function setDetailOptions() {
        // ì œëª© ë™ì  ë³€ê²½
        const facilityTitle = document.getElementById('facilityTitle');
        if (facilityName) {
            facilityTitle.innerHTML = `<span style="color: #3498db;">${facilityName}</span> ì‹œì„¤ ì´ìš© ì‹ ì²­`;
        }
        
        if (facilityName === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤') {
            detailCard.style.display = 'none';
            selectedFacility = facilityName; // ëŒ„ìŠ¤ì—°ìŠµì‹¤ì€ ì„¸ë¶€ì„ íƒ ì—†ìŒ
        } else {
            detailCard.style.display = '';
            let options = '';
            if (facilityName === 'ë‹Œí…ë„') {
                options = [
                    {v:'ë‹Œí…ë„1', t:'ğŸ® ë‹Œí…ë„1'},
                    {v:'ë‹Œí…ë„2', t:'ğŸ® ë‹Œí…ë„2'},
                    {v:'ë‹Œí…ë„3', t:'ğŸ® ë‹Œí…ë„3'},
                    {v:'ë‹Œí…ë„4', t:'ğŸ® ë‹Œí…ë„4'},
                    {v:'ë‹Œí…ë„5', t:'ğŸ® ë‹Œí…ë„5'},
                    {v:'ë‹Œí…ë„6', t:'ğŸ® ë‹Œí…ë„6'},
                    {v:'ë‹Œí…ë„7', t:'ğŸ® ë‹Œí…ë„7'},
                    {v:'ë‹Œí…ë„8', t:'ğŸ® ë‹Œí…ë„8'},
                    {v:'ë‹Œí…ë„9', t:'ğŸ® ë‹Œí…ë„9 â™¿'}
                ];
            } else if (facilityName === 'í”Œë ˆì´ìŠ¤í…Œì´ì…˜') {
                options = [
                    {v:'í”Œë ˆì´ìŠ¤í…Œì´ì…˜1', t:'ğŸ•¹ï¸ í”Œë ˆì´ìŠ¤í…Œì´ì…˜1'},
                    {v:'í”Œë ˆì´ìŠ¤í…Œì´ì…˜2', t:'ğŸ•¹ï¸ í”Œë ˆì´ìŠ¤í…Œì´ì…˜2'}
                ];
            } else if (facilityName === 'ë…¸ë˜ë°©') {
                options = [
                    {v:'ë…¸ë˜ë°©1', t:'ğŸ¤ ë…¸ë˜ë°©1'},
                    {v:'ë…¸ë˜ë°©2', t:'ğŸ¤ ë…¸ë˜ë°©2'}
                ];
            } else if (facilityName === 'ë³´ë“œê²Œì„') {
                options = [
                    {v:'ë³´ë“œê²Œì„1', t:'ğŸ² ë³´ë“œê²Œì„1'},
                    {v:'ë³´ë“œê²Œì„2', t:'ğŸ² ë³´ë“œê²Œì„2'}
                ];
            }
            detailSelect.innerHTML = options.map(o => `<option value="${o.v}">${o.t}</option>`).join('');
            // ì„ íƒëœ ì„¸ë¶€ì‹œì„¤ë¡œ selectedFacilityë¥¼ ëª…í™•íˆ í• ë‹¹
            selectedFacility = detailSelect.value;
        }
    }
    setDetailOptions();

    // ì„¸ë¶€ì„ íƒ ë²„íŠ¼ í´ë¦­
    detailSelect.addEventListener('change', function() {
        selectedFacility = this.value;
        // ì‹œê°„ ì„ íƒ ì˜ì—­ ì´ˆê¸°í™”
        selectedTime = null;
        // ì‹œê°„ ì„ íƒ UI ì¦‰ì‹œ ê°±ì‹ 
        showTimeSelect();
        // ì˜ˆì•½ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (í•„ìš”ì‹œ)
        // loadReservationData();
    });

    // ë‹¬ë ¥ ê´€ë ¨ ë³€ìˆ˜
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let today = new Date();
    today.setHours(0, 0, 0, 0);

    // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ë¡œì»¬ ì‹œê°„ëŒ€ ì‚¬ìš©)
    function formatDateToYYYYMMDD(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
        updateCalendarTitle();
        generateCalendar();
        
        // ì›” ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendarTitle();
            generateCalendar();
        });
        
        document.getElementById('nextMonth').addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendarTitle();
            generateCalendar();
        });
    }

    // ë‹¬ë ¥ ì œëª© ì—…ë°ì´íŠ¸
    function updateCalendarTitle() {
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        document.getElementById('calendarTitle').textContent = `${currentYear}ë…„ ${monthNames[currentMonth]}`;
    }

    // ë‹¬ë ¥ ìƒì„±
    function generateCalendar() {
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        let currentRow = document.createElement('tr');
        
        for (let i = 0; i < 42; i++) { // 6ì£¼ * 7ì¼
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            
            const dayCell = document.createElement('td');
            
            if (currentDate.getMonth() === currentMonth) {
                const dayNumber = currentDate.getDate();
                const dateString = formatDateToYYYYMMDD(currentDate);
                const isToday = currentDate.getTime() === today.getTime();
                const isPast = currentDate < today;
                const dayOfWeek = currentDate.getDay(); // 0: ì¼ìš”ì¼, 6: í† ìš”ì¼
                
                let dayClass = 'calendar-day';
                if (isPast) dayClass += ' disabled';
                if (isToday) dayClass += ' today';
                if (dayOfWeek === 0) dayClass += ' sunday'; // ì¼ìš”ì¼
                if (dayOfWeek === 6) dayClass += ' saturday'; // í† ìš”ì¼
                
                dayCell.innerHTML = `<div class="${dayClass}" data-date="${dateString}">${dayNumber}</div>`;
                
                if (isToday) {
                    dayCell.querySelector('.calendar-day').style.background = 'linear-gradient(90deg, #ffd6e3 0%, #a8edea 100%)';
                    dayCell.querySelector('.calendar-day').style.color = '#fff';
                    dayCell.querySelector('.calendar-day').style.fontWeight = '800';
                }
            }
            
            currentRow.appendChild(dayCell);
            
            if ((i + 1) % 7 === 0) {
                calendarBody.appendChild(currentRow);
                currentRow = document.createElement('tr');
            }
        }
        
        // ë‹¬ë ¥ ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸ ì¬ë“±ë¡
        document.getElementById('calendarBody').addEventListener('click', async function(e) {
            if (e.target.classList.contains('calendar-day') && !e.target.classList.contains('disabled') && e.target.textContent) {
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedDate = e.target.getAttribute('data-date');
                selectedTime = null;
                console.log('ë‚ ì§œ ì„ íƒë¨:', selectedDate); // ë””ë²„ê¹… ì¶”ê°€
                // ì˜ˆì•½ ë°ì´í„° í™•ì¸ í›„ ì‹œê°„ ì„ íƒ UI í‘œì‹œ
                await loadReservationData();
                showTimeSelect();
            }
        });
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™” ì‹¤í–‰
    initCalendar();

    function showTimeSelect() {
        const block = document.getElementById('timeSelectBlock');
        console.log('=== showTimeSelect í•¨ìˆ˜ í˜¸ì¶œ ==='); // ë””ë²„ê¹… ì¶”ê°€
        console.log('timeSelectBlock ìš”ì†Œ:', block); // ë””ë²„ê¹… ì¶”ê°€
        console.log('selectedDate:', selectedDate); // ë””ë²„ê¹… ì¶”ê°€
        
        // ë¬´ì¡°ê±´ ì‹œê°„ ì„ íƒ UIë¥¼ ë³´ì´ê²Œ í•¨
        block.style.display = 'block';
        
        console.log('ì‹œê°„ ì„ íƒ UI í‘œì‹œ:', selectedDate); // ë””ë²„ê¹…
        
        // ì˜ˆì•½ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
        if (Object.keys(reservationData).length === 0) {
            console.log('ì˜ˆì•½ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ì„œ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.'); // ë””ë²„ê¹… ì¶”ê°€
            reservationData = {}; // ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
        }
        
        console.log('ì‹œê°„ ì„ íƒ UI HTML ìƒì„± ì‹œì‘'); // ë””ë²„ê¹… ì¶”ê°€
        
        block.innerHTML = `
            <div style="margin-bottom: 20px; text-align: center;">
                <h3 style="color: #3498db; margin: 0;">ì„ íƒëœ ë‚ ì§œ: ${selectedDate}</h3>
            </div>
            <div class="time-btn-group">
                ${getTimeBtnsHTML()}
            </div>
        `;
        
        console.log('ì‹œê°„ ì„ íƒ UI HTML ìƒì„± ì™„ë£Œ'); // ë””ë²„ê¹… ì¶”ê°€
    }

    async function loadReservationData() {
        try {
            console.log('=== ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            const response = await fetch('/api/reservations');
            const reservations = await response.json();
            console.log('APIì—ì„œ ë°›ì€ ì›ë³¸ ì˜ˆì•½ ë°ì´í„°:', reservations);
            reservationData = {};
            reservations.forEach((reservation, index) => {
                // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
                const detailKey = (reservation.facility === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤' || reservation.facility === 'ë‹¤ëª©ì ì‹¤') ? '-' : reservation.detail;
                const key = reservation.facility + '||' + (detailKey || '-');
                if (!reservationData[key]) reservationData[key] = {};
                if (!reservationData[key][reservation.date]) reservationData[key][reservation.date] = [];
                if (!reservation.status || reservation.status === 'active') {
                    // ì˜ˆì•½ êµ¬ê°„ ì „ì²´ ì‹œê°„ëŒ€ push
                    const startHour = parseInt(reservation.start_time.split(':')[0]);
                    const endHour = parseInt(reservation.end_time.split(':')[0]);
                    for (let h = startHour; h < endHour; h++) {
                        const timeStr = `${h.toString().padStart(2, '0')}:00`;
                        if (!reservationData[key][reservation.date].includes(timeStr)) {
                            reservationData[key][reservation.date].push(timeStr);
                        }
                    }
                }
            });
            console.log('ìµœì¢… ì •ë¦¬ëœ ì˜ˆì•½ ë°ì´í„°:', reservationData);
        } catch (error) {
            console.error('ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // ì‹œê°„ ìŠ¬ë¡¯ ìƒì„± í•¨ìˆ˜ ì¶”ê°€
    function getTimeSlotsForFacility(facility) {
        // ë‹Œí…ë„1~9, í”Œë ˆì´ìŠ¤í…Œì´ì…˜1~2ë§Œ 30ë¶„ ë‹¨ìœ„
        if (facility && (facility.includes('ë‹Œí…ë„') || facility.includes('í”Œë ˆì´ìŠ¤í…Œì´ì…˜'))) {
            // 09:00 ~ 19:00, 30ë¶„ ë‹¨ìœ„
            const slots = [];
            for (let h = 9; h <= 19; h++) {
                slots.push(`${String(h).padStart(2, '0')}:00`);
                if (h !== 19) slots.push(`${String(h).padStart(2, '0')}:30`);
            }
            return slots;
        } else {
            // 1ì‹œê°„ ë‹¨ìœ„
            return ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
        }
    }

    // getTimeBtnsHTML í•¨ìˆ˜ ë‚´ ì‹œê°„ ìŠ¬ë¡¯ ìƒì„± ë¶€ë¶„ì„ êµì²´
    function getTimeBtnsHTML() {
        // ë‹Œí…ë„1~9ë§Œ 30ë¶„ ë‹¨ìœ„, ê·¸ ì™¸ëŠ” 1ì‹œê°„ ë‹¨ìœ„
        const slots = getTimeSlotsForFacility(facilityName === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤' ? facilityName : (selectedFacility || facilityName));
        // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
        const detailKey = (facilityName === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤' || facilityName === 'ë‹¤ëª©ì ì‹¤') ? '-' : selectedFacility;
        const reserved = Object.keys(reservationData).length > 0 ? 
            getReservedTimes(facilityName, detailKey, selectedDate) : [];
        let html = '';
        slots.forEach(time => {
            const paddedTime = time.padStart(5, '0');
            const isReserved = reserved.map(t => t.padStart(5, '0')).includes(paddedTime);
            let isPastTime = false;
            if (selectedDate === formatDateToYYYYMMDD(today)) {
                const [hour, minute] = time.split(':').map(Number);
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                if (hour < currentHour || (hour === currentHour && minute <= currentMinute)) {
                    isPastTime = true;
                }
            }
            const isDisabled = isReserved || isPastTime;
            const disabledText = isReserved ? ' (ì˜ˆì•½ë¨)' : '';
            let buttonClass = 'time-btn';
            if (isDisabled) buttonClass += ' disabled';
            if (selectedTime === time) buttonClass += ' selected';
            let buttonHtml = `<button class="${buttonClass}" data-time="${time}"`;
            if (isDisabled) buttonHtml += ' disabled';
            buttonHtml += `>${time}${disabledText}</button>`;
            html += buttonHtml;
        });
        return html;
    }

    // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ë™ì‘
    const actions = document.querySelector('.form-actions-centered');
    if (actions) {
        const [prevBtn, nextBtn] = actions.querySelectorAll('button');
        prevBtn.onclick = function(e) {
            e.preventDefault();
            window.location.href = 'select-facility.html';
        };
        nextBtn.onclick = function(e) {
            e.preventDefault();
            
            console.log('ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ - ì„ íƒëœ í•­ëª©ë“¤:'); // ë””ë²„ê¹…
            console.log('ì‹œì„¤:', facilityName);
            console.log('ì„¸ë¶€ì„ íƒ:', detailSelect.value);
            console.log('ë‚ ì§œ:', selectedDate);
            console.log('ì‹œê°„:', selectedTime);
            
            // ìœ íš¨ì„± ê²€ì‚¬
            let needDetail = facilityName !== 'ëŒ„ìŠ¤ì—°ìŠµì‹¤';
            let detailValue = needDetail ? detailSelect.value : null;
            
            if (needDetail && !detailValue) {
                showModal('ì„¸ë¶€ì„ íƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedDate) {
                showModal('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedTime) {
                showModal('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì˜ˆì•½ ë°ì´í„° ì¤€ë¹„
            const userName = localStorage.getItem('userName') || 'ê³ ê°';
            const userPhone = localStorage.getItem('userPhone') || '';
            
            const userGender = localStorage.getItem('userGender') || '';
            const userAge = localStorage.getItem('userAge') || '';
            const reservationData = {
                name: userName,
                phone: userPhone || undefined, // ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  undefined ì „ì†¡
                facility: facilityName, // ì¼ë°˜ ì‹œì„¤ëª…
                detail: detailValue || '-', // ì„¸ë¶€ì„ íƒ
                date: selectedDate,
                start_time: selectedTime,
                end_time: getEndTime(selectedTime), // 1ì‹œê°„ í›„
                purpose: '',
                gender: userGender,
                age: userAge
            };
            
            console.log('ì˜ˆì•½ ë°ì´í„°:', reservationData); // ë””ë²„ê¹…
            
            // ì˜ˆì•½ API í˜¸ì¶œ
            createReservation(reservationData);
        };
    }

    // ì¢…ë£Œ ì‹œê°„ ê³„ì‚° (1ì‹œê°„ í›„)
    function getEndTime(startTime) {
        const [hour, minute] = startTime.split(':').map(Number);
        const endHour = hour + 1;
        return `${endHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    }
    
    // ì˜ˆì•½ ìƒì„± API í˜¸ì¶œ
    async function createReservation(data) {
        try {
            // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
            if (data.facility === 'ëŒ„ìŠ¤ì—°ìŠµì‹¤' || data.facility === 'ë‹¤ëª©ì ì‹¤') {
                data.detail = '-';
            }
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) {
                showModal(result.error || 'ì˜ˆì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            localStorage.setItem('reservationFacility', data.facility);
            localStorage.setItem('reservationDetail', data.detail);
            localStorage.setItem('reservationDate', data.date);
            localStorage.setItem('reservationTime', data.start_time);
            localStorage.setItem('reservationId', result.id);
            window.location.href = 'reservation-complete.html';
        } catch (error) {
            console.error('ì˜ˆì•½ ìƒì„± ì˜¤ë¥˜:', error);
            showModal('ì˜ˆì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê°„ë‹¨í•œ ëª¨ë‹¬ í•¨ìˆ˜ ì¶”ê°€
    function showModal(msg) {
        let modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.left = 0;
        modal.style.top = 0;
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.35)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = 9999;
        modal.innerHTML = `<div style="background:#fff;padding:32px 28px;border-radius:18px;box-shadow:0 4px 24px #3498db22;font-size:1.15rem;font-weight:600;color:#3498db;text-align:center;min-width:220px;max-width:90vw;">${msg}<br><br><button style='margin-top:18px;padding:10px 28px;border-radius:12px;background:linear-gradient(90deg,#a8edea,#fed6e3);border:none;font-weight:700;font-size:1.08rem;color:#222;cursor:pointer;' onclick='this.parentElement.parentElement.remove()'>í™•ì¸</button></div>`;
        document.body.appendChild(modal);
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œì—ë„ ë‹«ê¸°
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // ì˜ˆì•½ ë°ì´í„° í™•ì¸ í›„ ì‹œê°„ ì„ íƒ UI í‘œì‹œ
    async function checkReservationsAndShowTimeSelect() {
        console.log('=== checkReservationsAndShowTimeSelect í•¨ìˆ˜ í˜¸ì¶œ ==='); // ë””ë²„ê¹… ì¶”ê°€
        console.log('selectedDate:', selectedDate); // ë””ë²„ê¹… ì¶”ê°€
        console.log('í˜„ì¬ ì˜ˆì•½ ë°ì´í„° í‚¤ ê°œìˆ˜:', Object.keys(reservationData).length); // ë””ë²„ê¹… ì¶”ê°€
        
        // ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ì–´ë„ ì‹œê°„ ì„ íƒ UIë¥¼ í‘œì‹œ
        if (Object.keys(reservationData).length === 0) {
            console.log('ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ì–´ë„ ì‹œê°„ ì„ íƒ UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.'); // ë””ë²„ê¹… ì¶”ê°€
        }
        
        console.log('showTimeSelect í•¨ìˆ˜ í˜¸ì¶œ'); // ë””ë²„ê¹… ì¶”ê°€
        showTimeSelect();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        loadReservationData();
    });
    </script>
</body>
</html> 